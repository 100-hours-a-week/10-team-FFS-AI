name: AI CD

# ============================================================
# ğŸ¯ CIê°€ ì„±ê³µí•œ í›„ì—ë§Œ ë°°í¬ ì‹¤í–‰
# - workflow_run: CI ì™„ë£Œ í›„ íŠ¸ë¦¬ê±°
# - dev ë¸Œëœì¹˜ â†’ dev ì„œë²„ (ìë™)
# - main ë¸Œëœì¹˜ â†’ prod ì„œë²„ (ìˆ˜ë™ ìŠ¹ì¸)
# ============================================================
on:
  workflow_run:
    workflows: ["AI CI"]  # CI ì›Œí¬í”Œë¡œìš° ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•¨
    types:
      - completed
    branches:
      - dev
      - main

  # ìˆ˜ë™ ë°°í¬ ì˜µì…˜
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        type: choice
        options:
          - development
          - production

permissions:
  contents: read
  actions: read

# ============================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ============================================================
env:
  APP_DIR: /app/ai
  BACKUP_DIR: /app/backups/ai
  SCRIPTS_DIR: /app/scripts

# ============================================================
# Dev í™˜ê²½ ë°°í¬ (dev ë¸Œëœì¹˜)
# ============================================================
jobs:
  deploy-dev:
    name: Deploy to Development
    # CIê°€ ì„±ê³µí–ˆê³ , dev ë¸Œëœì¹˜ì´ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ development ì„ íƒ ì‹œ
    if: |
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'dev') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'development')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # ------------------------------------------------------
      # 2. CI ê²°ê³¼ í™•ì¸ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
      # ------------------------------------------------------
      - name: âœ… Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          echo "CI Workflow Status: ${{ github.event.workflow_run.conclusion }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"

          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI did not succeed. Aborting deployment."
            exit 1
          fi

          echo "âœ… CI succeeded. Proceeding with deployment."

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Dev Server Status Check ==="

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            df -h ${{ env.APP_DIR }}
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 90 ]; then
              echo "âš ï¸ WARNING: Disk usage is high: ${DISK_USAGE}%"
            fi

            # Qdrant & Redis í™•ì¸
            curl -sf http://localhost:6333/ > /dev/null && echo "âœ… Qdrant OK" || echo "âš ï¸ Qdrant issue"
            redis-cli -p 6380 ping > /dev/null 2>&1 && echo "âœ… Redis OK" || echo "âš ï¸ Redis issue"

            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }} /tmp/ai-deploy

      # ------------------------------------------------------
      # 4. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer files to Dev Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          source: "app/,requirements.txt"
          target: "/tmp/ai-deploy"
          overwrite: true
          strip_components: 0

      # ------------------------------------------------------
      # 5. ë°°í¬ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Deploy application
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          command_timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if [ -f "${{ env.SCRIPTS_DIR }}/deploy-ai.sh" ]; then
              echo "Using deploy script..."
              chmod +x ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
              rm -rf /tmp/ai-deploy-staging
              mv /tmp/ai-deploy /tmp/ai-deploy-staging
              bash ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
            else
              # ê¸°ë³¸ ë°°í¬
              echo "Basic deployment..."

              # ë°±ì—…
              if [ -d "app" ]; then
                TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                tar -czf ${{ env.BACKUP_DIR }}/ai-app_dev_backup_$TIMESTAMP.tar.gz app/ requirements.txt 2>/dev/null || true
              fi

              # ìƒˆ ë²„ì „ ì ìš©
              rm -rf app/
              cp -r /tmp/ai-deploy/app .
              cp /tmp/ai-deploy/requirements.txt .

              # ê°€ìƒí™˜ê²½ ì—…ë°ì´íŠ¸
              if [ -d "venv" ]; then
                source venv/bin/activate
                pip install -r requirements.txt --quiet
              fi

              # ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
              pkill -f "gunicorn.*app.main:app" || true
              sleep 3

              nohup gunicorn app.main:app \
                --workers 2 \
                --worker-class uvicorn.workers.UvicornWorker \
                --bind 0.0.0.0:8000 \
                --log-level info \
                > logs/service.log 2>&1 &
            fi

            rm -rf /tmp/ai-deploy /tmp/ai-deploy-staging

      # ------------------------------------------------------
      # 6. ë°°í¬ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Deployment Verification ==="
            sleep 5

            if ! pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              echo "âŒ Application not running!"
              exit 1
            fi

            # í—¬ìŠ¤ì²´í¬
            MAX_RETRIES=10
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
                curl -s http://localhost:8000/health | jq '.' || true
                exit 0
              fi
              echo "Waiting... ($i/$MAX_RETRIES)"
              sleep 5
            done

            echo "âŒ Health check failed!"
            exit 1

      # ------------------------------------------------------
      # 7. Discord ì•Œë¦¼
      # ------------------------------------------------------
      - name: ğŸ“¢ Discord notification
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ steps.deploy.outcome == 'success' && 'âœ…' || 'âŒ' }} Dev ë°°í¬ ${{ steps.deploy.outcome == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch || github.ref_name }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha || github.sha }}`
            **CI ê²°ê³¼:** âœ… ì„±ê³µ

            [ğŸ“‹ ë°°í¬ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: ${{ steps.deploy.outcome == 'success' && '3066993' || '15158332' }}

  # ============================================================
  # Production í™˜ê²½ ë°°í¬ (main ë¸Œëœì¹˜)
  # ğŸ” Continuous Delivery: ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”
  # ============================================================
  deploy-prod:
    name: Deploy to Production
    # CIê°€ ì„±ê³µí–ˆê³ , main ë¸Œëœì¹˜ì´ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ production ì„ íƒ ì‹œ
    if: |
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment:
      name: ai-environment  # âš ï¸ GitHub Settingsì—ì„œ ìŠ¹ì¸ì ì„¤ì • í•„ìš”
    timeout-minutes: 30  # ìŠ¹ì¸ ëŒ€ê¸° ì‹œê°„ í¬í•¨

    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      # ------------------------------------------------------
      # 2. CI ê²°ê³¼ í™•ì¸ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
      # ------------------------------------------------------
      - name: âœ… Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          echo "=== CI Verification ==="
          echo "CI Status: ${{ github.event.workflow_run.conclusion }}"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Commit: ${{ github.event.workflow_run.head_sha }}"

          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI did not succeed. Aborting production deployment."
            exit 1
          fi

          echo "âœ… CI succeeded. Ready for production deployment."

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check Production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Server Status Check ==="

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (ë” ì—„ê²©)
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 85 ]; then
              echo "âŒ ERROR: Disk usage too high: ${DISK_USAGE}%"
              exit 1
            fi

            # Qdrant í•„ìˆ˜ í™•ì¸
            if ! curl -sf http://localhost:6333/ > /dev/null; then
              echo "âŒ Qdrant is not accessible!"
              exit 1
            fi

            # Redis í•„ìˆ˜ í™•ì¸
            if ! redis-cli -p 6380 ping > /dev/null 2>&1; then
              echo "âŒ Redis is not accessible!"
              exit 1
            fi

            echo "âœ… Production server check passed"
            mkdir -p ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }} /tmp/ai-deploy

      # ------------------------------------------------------
      # 4. í˜„ì¬ ë²„ì „ ë°±ì—…
      # ------------------------------------------------------
      - name: ğŸ’¾ Backup current version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            if [ -d "app" ]; then
              tar -czf ${{ env.BACKUP_DIR }}/ai-app_prod_$TIMESTAMP.tar.gz app/ requirements.txt
              echo "âœ… Production backup created"

              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (ìµœê·¼ 10ê°œë§Œ ìœ ì§€)
              cd ${{ env.BACKUP_DIR }}
              ls -t ai-app_prod_*.tar.gz 2>/dev/null | tail -n +11 | xargs -r rm -v
            fi

      # ------------------------------------------------------
      # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer to Production
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          source: "app/,requirements.txt"
          target: "/tmp/ai-deploy"
          overwrite: true

      # ------------------------------------------------------
      # 6. ë°°í¬ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Deploy to Production
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          command_timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}

            if [ -f "${{ env.SCRIPTS_DIR }}/deploy-ai.sh" ]; then
              rm -rf /tmp/ai-deploy-staging
              mv /tmp/ai-deploy /tmp/ai-deploy-staging
              chmod +x ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
              bash ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
            else
              # ê¸°ë³¸ ë°°í¬
              rm -rf app/
              cp -r /tmp/ai-deploy/app .
              cp /tmp/ai-deploy/requirements.txt .

              if [ -d "venv" ]; then
                source venv/bin/activate
                pip install -r requirements.txt --quiet
              fi

              # Zero-downtime reload
              if pgrep -f "gunicorn.*master" > /dev/null; then
                MASTER_PID=$(pgrep -f "gunicorn.*master" | head -1)
                kill -HUP $MASTER_PID
                echo "âœ… Graceful reload"
              else
                nohup gunicorn app.main:app \
                  --workers 4 \
                  --worker-class uvicorn.workers.UvicornWorker \
                  --bind 0.0.0.0:8000 \
                  > logs/service.log 2>&1 &
              fi
            fi

            rm -rf /tmp/ai-deploy /tmp/ai-deploy-staging

      # ------------------------------------------------------
      # 7. ë°°í¬ ê²€ì¦ & Smoke Test
      # ------------------------------------------------------
      - name: ğŸ§ª Verify & Smoke Test
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Verification ==="
            sleep 5

            if ! pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              echo "âŒ Application not running!"
              exit 1
            fi

            # í—¬ìŠ¤ì²´í¬ & Smoke tests
            for i in $(seq 1 10); do
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health check passed"

                # Service connectivity check
                HEALTH=$(curl -s http://localhost:8000/health)
                QDRANT=$(echo $HEALTH | jq -r '.services.qdrant')
                REDIS=$(echo $HEALTH | jq -r '.services.redis')

                if [ "$QDRANT" != "connected" ] || [ "$REDIS" != "connected" ]; then
                  echo "âŒ Service connectivity issue"
                  exit 1
                fi

                echo "âœ… All smoke tests passed"
                exit 0
              fi
              sleep 5
            done

            echo "âŒ Verification failed!"
            exit 1

      # ------------------------------------------------------
      # 8. ë¡¤ë°± (ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: âš ï¸ Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Rolling back ==="
            cd ${{ env.BACKUP_DIR }}

            LATEST_BACKUP=$(ls -t ai-app_prod_*.tar.gz 2>/dev/null | head -1)

            if [ -n "$LATEST_BACKUP" ]; then
              cd ${{ env.APP_DIR }}
              tar -xzf ${{ env.BACKUP_DIR }}/$LATEST_BACKUP

              pkill -f "gunicorn.*app.main:app" || true
              sleep 3
              nohup gunicorn app.main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 > logs/service.log 2>&1 &

              sleep 5
              if curl -f -s http://localhost:8000/health > /dev/null; then
                echo "âœ… Rollback successful"
              else
                echo "âŒ Rollback failed!"
              fi
            else
              echo "âŒ No backup found!"
            fi

      # ------------------------------------------------------
      # 9. Discord ì•Œë¦¼
      # ------------------------------------------------------
      - name: ğŸ“¢ Discord notification
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ steps.deploy.outcome == 'success' && 'âœ… Production ë°°í¬ ì„±ê³µ' || 'âŒ Production ë°°í¬ ì‹¤íŒ¨' }}"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch || github.ref_name }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha || github.sha }}`
            **CI ê²°ê³¼:** âœ… ì„±ê³µ

            ${{ steps.deploy.outcome == 'failure' && 'âš ï¸ ìë™ ë¡¤ë°± ì™„ë£Œ' || 'ğŸ‰ ë°°í¬ ì™„ë£Œ' }}

            [ğŸ“‹ ë°°í¬ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: ${{ steps.deploy.outcome == 'success' && '3066993' || '15158332' }}
