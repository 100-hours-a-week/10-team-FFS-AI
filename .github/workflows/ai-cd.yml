name: AI CD

on:
  workflow_run:
    workflows: ["AI CI"]
    types:
      - completed
    branches:
      - dev
      - main

  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        type: choice
        options:
          - development
          - production

permissions:
  contents: read
  actions: read

env:
  APP_DIR: /home/ubuntu/app/ai
  BACKUP_DIR: /home/ubuntu/app/backups/ai
  LOG_DIR: /home/ubuntu/app/ai/logs
  SERVICE_NAME: klosetlab-ai.service

# ============================================================
# Dev í™˜ê²½ ë°°í¬
# ============================================================
jobs:
  deploy-dev:
    name: Deploy to Development
    if: |
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'dev') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'development')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: âœ… Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI did not succeed. Aborting deployment."
            exit 1
          fi

      # ------------------------------------------------------
      # ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Dev Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            df -h ${{ env.APP_DIR }}
            
            # Qdrant & Redis í™•ì¸
            curl -sf http://localhost:6333/ > /dev/null && echo "âœ… Qdrant OK" || echo "âš ï¸ Qdrant issue"
            redis-cli -p 6380 ping > /dev/null 2>&1 && echo "âœ… Redis OK" || echo "âš ï¸ Redis issue"
            
            # systemd ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âœ… AI Service is running"
              sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -10
            else
              echo "âš ï¸ AI Service is not running (will be started)"
            fi
            
            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }} ${{ env.LOG_DIR }} /tmp/ai-deploy

      - name: ğŸ“¤ Transfer files to Dev Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          source: "app/,requirements.txt"
          target: "/tmp/ai-deploy"
          overwrite: true
          strip_components: 0

      # ------------------------------------------------------
      # ë°°í¬ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Deploy application
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            
            cd ${{ env.APP_DIR }}
            echo "Working directory: $(pwd)"
            
            # ë°±ì—… ìƒì„±
            if [ -d "app" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              echo "Creating backup: ai-app_dev_backup_$TIMESTAMP.tar.gz"
              tar -czf ${{ env.BACKUP_DIR }}/ai-app_dev_backup_$TIMESTAMP.tar.gz app/ requirements.txt 2>/dev/null || true
              
              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
              cd ${{ env.BACKUP_DIR }}
              ls -t ai-app_dev_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -v
              cd ${{ env.APP_DIR }}
            fi
            
            # ìƒˆ ë²„ì „ ì ìš©
            echo "Applying new version..."
            rm -rf app/
            cp -r /tmp/ai-deploy/app .
            cp /tmp/ai-deploy/requirements.txt .
            
            # ê°€ìƒí™˜ê²½ ì—…ë°ì´íŠ¸
            if [ -d "venv" ]; then
              echo "Updating virtual environment..."
              source venv/bin/activate
              pip install -r requirements.txt --quiet --no-cache-dir
            else
              echo "âŒ Virtual environment not found!"
              exit 1
            fi
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.LOG_DIR }}
            
            # systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "Restarting AI service via systemd..."
            sudo systemctl restart ${{ env.SERVICE_NAME }}
            
            # ì‹œì‘ ëŒ€ê¸°
            sleep 5
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âœ… Service restarted successfully"
              sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -20
            else
              echo "âŒ Service failed to start"
              echo "=== Recent service logs ==="
              sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
              exit 1
            fi
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /tmp/ai-deploy

      # ------------------------------------------------------
      # ë°°í¬ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Verify deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Deployment Verification ==="
            
            # systemd ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if ! sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âŒ Service is not running!"
              sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
            MAX_RETRIES=6
            for i in $(seq 1 $MAX_RETRIES); do
              echo "Health check attempt $i/$MAX_RETRIES..."
              
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
                echo ""
                echo "=== Health Check Response ==="
                curl -s http://localhost:8000/health | python3 -m json.tool || curl -s http://localhost:8000/health
                echo ""
                echo "=== Service Status ==="
                sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -20
                exit 0
              fi
              
              sleep 5
            done
            
            echo "âŒ Health check failed after $MAX_RETRIES attempts!"
            echo ""
            echo "=== Recent error logs ==="
            tail -50 ${{ env.LOG_DIR }}/error.log || true
            echo ""
            echo "=== Service logs ==="
            sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
            exit 1

      - name: ğŸ“¢ Discord notification
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ steps.deploy.outcome == 'success' && 'âœ…' || 'âŒ' }} Dev ë°°í¬ ${{ steps.deploy.outcome == 'success' && 'ì„±ê³µ' || 'ì‹¤íŒ¨' }}"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch || github.ref_name }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha || github.sha }}`
            **ì„œë¹„ìŠ¤:** systemd (${{ env.SERVICE_NAME }})
            
            [ğŸ“‹ ë°°í¬ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: ${{ steps.deploy.outcome == 'success' && '3066993' || '15158332' }}

  # ============================================================
  # Production í™˜ê²½ ë°°í¬
  # ============================================================
  deploy-prod:
    name: Deploy to Production
    if: |
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    runs-on: ubuntu-latest
    environment:
      name: ai-environment
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: âœ… Verify CI success
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "âŒ CI did not succeed. Aborting production deployment."
            exit 1
          fi

      - name: ğŸ” Check Production server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ (ë” ì—„ê²©)
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 85 ]; then
              echo "âŒ ERROR: Disk usage too high: ${DISK_USAGE}%"
              exit 1
            fi
            echo "âœ… Disk usage: ${DISK_USAGE}%"
            
            # Qdrant í•„ìˆ˜ í™•ì¸
            if ! curl -sf http://localhost:6333/ > /dev/null; then
              echo "âŒ Qdrant is not accessible!"
              exit 1
            fi
            echo "âœ… Qdrant is accessible"
            
            # Redis í•„ìˆ˜ í™•ì¸
            if ! redis-cli -p 6380 ping > /dev/null 2>&1; then
              echo "âŒ Redis is not accessible!"
              exit 1
            fi
            echo "âœ… Redis is accessible"
            
            # systemd ì„œë¹„ìŠ¤ ìƒíƒœ
            if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âœ… AI Service is running"
              sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -10
            else
              echo "âš ï¸ AI Service is not running"
            fi
            
            echo "âœ… Production server check passed"
            mkdir -p ${{ env.APP_DIR }} ${{ env.BACKUP_DIR }} ${{ env.LOG_DIR }} /tmp/ai-deploy

      - name: ğŸ’¾ Backup current version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            if [ -d "app" ]; then
              echo "Creating production backup: ai-app_prod_$TIMESTAMP.tar.gz"
              tar -czf ${{ env.BACKUP_DIR }}/ai-app_prod_$TIMESTAMP.tar.gz app/ requirements.txt
              echo "âœ… Production backup created"
              
              # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (ìµœê·¼ 10ê°œë§Œ ìœ ì§€)
              cd ${{ env.BACKUP_DIR }}
              ls -t ai-app_prod_*.tar.gz 2>/dev/null | tail -n +11 | xargs -r rm -v
            else
              echo "âš ï¸ No existing app directory to backup"
            fi

      - name: ğŸ“¤ Transfer to Production
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          source: "app/,requirements.txt"
          target: "/tmp/ai-deploy"
          overwrite: true

      - name: ğŸš€ Deploy to Production
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          command_timeout: 300s
          script: |
            set -e
            
            cd ${{ env.APP_DIR }}
            echo "Working directory: $(pwd)"
            
            # ìƒˆ ë²„ì „ ì ìš©
            echo "Applying new version..."
            rm -rf app/
            cp -r /tmp/ai-deploy/app .
            cp /tmp/ai-deploy/requirements.txt .
            
            # ê°€ìƒí™˜ê²½ ì—…ë°ì´íŠ¸
            if [ -d "venv" ]; then
              echo "Updating virtual environment..."
              source venv/bin/activate
              pip install -r requirements.txt --quiet --no-cache-dir
            else
              echo "âŒ Virtual environment not found!"
              exit 1
            fi
            
            # ë¡œê·¸ ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.LOG_DIR }}
            
            # âœ… Zero-downtime reload (Gunicornì˜ Graceful reload)
            if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "Performing graceful reload..."
              sudo systemctl reload ${{ env.SERVICE_NAME }}
              echo "âœ… Graceful reload signal sent"
              sleep 5
            else
              echo "Service not running, starting fresh..."
              sudo systemctl start ${{ env.SERVICE_NAME }}
              sleep 5
            fi
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âœ… Service is running"
              sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -20
            else
              echo "âŒ Service failed to start/reload"
              sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
              exit 1
            fi
            
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            rm -rf /tmp/ai-deploy

      - name: ğŸ§ª Verify & Smoke Test
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Verification ==="
            
            # systemd ì„œë¹„ìŠ¤ í™•ì¸
            if ! sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
              echo "âŒ Service is not running!"
              sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ & Smoke tests
            for i in $(seq 1 10); do
              echo "Health check attempt $i/10..."
              
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Health check passed"
                
                # Service connectivity check
                HEALTH=$(curl -s http://localhost:8000/health)
                echo ""
                echo "=== Health Response ==="
                echo "$HEALTH" | python3 -m json.tool || echo "$HEALTH"
                
                QDRANT=$(echo $HEALTH | python3 -c "import sys, json; print(json.load(sys.stdin)['services']['qdrant'])" 2>/dev/null || echo "unknown")
                REDIS=$(echo $HEALTH | python3 -c "import sys, json; print(json.load(sys.stdin)['services']['redis'])" 2>/dev/null || echo "unknown")
                
                if [ "$QDRANT" != "connected" ] || [ "$REDIS" != "connected" ]; then
                  echo "âš ï¸ Service connectivity issue (Qdrant: $QDRANT, Redis: $REDIS)"
                  exit 1
                fi
                
                echo ""
                echo "=== Service Status ==="
                sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -20
                
                echo ""
                echo "âœ… All smoke tests passed"
                exit 0
              fi
              
              sleep 5
            done
            
            echo "âŒ Verification failed after 10 attempts!"
            echo ""
            echo "=== Error logs ==="
            tail -50 ${{ env.LOG_DIR }}/error.log || true
            echo ""
            echo "=== Service logs ==="
            sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
            exit 1

      - name: âš ï¸ Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Rolling back to previous version ==="
            cd ${{ env.BACKUP_DIR }}
            
            LATEST_BACKUP=$(ls -t ai-app_prod_*.tar.gz 2>/dev/null | head -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "Found backup: $LATEST_BACKUP"
              cd ${{ env.APP_DIR }}
              
              # ë°±ì—… ë³µì›
              tar -xzf ${{ env.BACKUP_DIR }}/$LATEST_BACKUP
              
              # ê°€ìƒí™˜ê²½ ì—…ë°ì´íŠ¸
              if [ -d "venv" ]; then
                source venv/bin/activate
                pip install -r requirements.txt --quiet
              fi
              
              # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
              sudo systemctl restart ${{ env.SERVICE_NAME }}
              sleep 5
              
              # ë¡¤ë°± ê²€ì¦
              if sudo systemctl is-active --quiet ${{ env.SERVICE_NAME }}; then
                if curl -f -s http://localhost:8000/health > /dev/null; then
                  echo "âœ… Rollback successful"
                  sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -10
                else
                  echo "âš ï¸ Service running but health check failed"
                fi
              else
                echo "âŒ Rollback failed - service not running!"
                sudo journalctl -u ${{ env.SERVICE_NAME }} -n 50 --no-pager
              fi
            else
              echo "âŒ No backup found for rollback!"
            fi

      - name: ğŸ“¢ Discord notification
        if: always()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "${{ steps.deploy.outcome == 'success' && 'âœ… Production ë°°í¬ ì„±ê³µ' || 'âŒ Production ë°°í¬ ì‹¤íŒ¨' }}"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch || github.ref_name }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha || github.sha }}`
            **ì„œë¹„ìŠ¤:** systemd (${{ env.SERVICE_NAME }})
            
            ${{ steps.deploy.outcome == 'failure' && 'âš ï¸ ìë™ ë¡¤ë°± ì‹œë„ë¨' || 'ğŸ‰ Graceful reload ì™„ë£Œ' }}
            
            [ğŸ“‹ ë°°í¬ ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: ${{ steps.deploy.outcome == 'success' && '3066993' || '15158332' }}