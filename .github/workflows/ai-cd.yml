name: AI CD

# ============================================================
# íŠ¸ë¦¬ê±° ì„¤ì •: CI ì›Œí¬í”Œë¡œìš° ì™„ë£Œ í›„ ìë™ ì‹¤í–‰
# ============================================================
on:
  workflow_run:
    workflows: ["AI CI"]
    types:
      - completed
    branches:
      - dev
      - main

permissions:
  contents: read
  actions: read

# ============================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ============================================================
env:
  APP_DIR: /app/ai
  BACKUP_DIR: /app/backups/ai
  SCRIPTS_DIR: /app/scripts

# ============================================================
# Dev í™˜ê²½ ë°°í¬
# ============================================================
jobs:
  deploy-dev:
    name: Deploy to Development
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest
    environment:
      name: ai-development
    timeout-minutes: 15

    steps:
      # ------------------------------------------------------
      # 1. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download build metadata
        uses: actions/download-artifact@v4
        with:
          name: ai-build-metadata-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: ğŸ“‹ Display build metadata
        run: |
          if [ -f metadata.json ]; then
            echo "### ğŸ“Š Build Metadata" >> $GITHUB_STEP_SUMMARY
            cat metadata.json | jq '.' >> $GITHUB_STEP_SUMMARY
            cat metadata.json
          else
            echo "âš ï¸ Build metadata not found"
          fi

      # ------------------------------------------------------
      # 2. ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download application artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-app-dev-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "### ğŸ“¦ Downloaded Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lhR >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -d "app" ]; then
            echo "::error::app directory not found!"
            exit 1
          fi
          
          if [ ! -f "requirements.txt" ]; then
            echo "::error::requirements.txt not found!"
            exit 1
          fi
          
          echo "âœ… Artifact verification passed"

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status before deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ“Š Disk Usage:"
            df -h ${{ env.APP_DIR }}
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 90 ]; then
              echo "::warning::Disk usage is high: ${DISK_USAGE}%"
            fi
            
            # ë©”ëª¨ë¦¬ í™•ì¸
            echo "ğŸ’¾ Memory Usage:"
            free -h
            
            # Qdrant ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking Qdrant..."
            if curl -sf http://localhost:6333/ > /dev/null; then
              echo "âœ… Qdrant is running"
            else
              echo "âš ï¸ Qdrant is not accessible"
            fi
            
            # Redis ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking Redis..."
            if redis-cli -p 6380 ping > /dev/null 2>&1; then
              echo "âœ… Redis is running"
            else
              echo "âš ï¸ Redis is not accessible"
            fi
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
            echo "ğŸ”„ Current Process:"
            if pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              echo "âœ… Application is currently running"
              PID=$(pgrep -f "gunicorn.*app.main:app")
              echo "Current PID: $PID"
            else
              echo "âš ï¸ Application is not running"
            fi
            
            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p ${{ env.BACKUP_DIR }}
            mkdir -p /tmp/ai-deploy
            
            echo "âœ… Server check completed"

      # ------------------------------------------------------
      # 4. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer application to Dev Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          source: "app/,requirements.txt,build-artifacts/"
          target: "/tmp/ai-deploy"
          overwrite: true
          strip_components: 0

      # ------------------------------------------------------
      # 5. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Run deployment script
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          command-timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}
            
            # ìƒˆ ë²„ì „ ì¤€ë¹„
            echo "Preparing new version..."
            sudo rm -rf /tmp/ai-deploy-staging
            sudo mv /tmp/ai-deploy /tmp/ai-deploy-staging
            
            # deploy.sh ì‹¤í–‰ ê¶Œí•œ í™•ì¸
            if [ ! -x "${{ env.SCRIPTS_DIR }}/deploy-ai.sh" ]; then
              echo "Making deploy-ai.sh executable..."
              chmod +x ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
            fi
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "${{ env.SCRIPTS_DIR }}/deploy-ai.sh" ]; then
              echo "Executing deploy-ai.sh..."
              bash ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
            else
              echo "ERROR: deploy-ai.sh not found!"
              exit 1
            fi

      # ------------------------------------------------------
      # 6. ë°°í¬ í›„ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Post-deployment verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            echo "=== Post-Deployment Verification ==="
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              PID=$(pgrep -f "gunicorn.*app.main:app")
              PID_COUNT=$(pgrep -f "gunicorn.*app.main:app" | wc -l)
              echo "âœ… Application is running (Master PID: $(pgrep -f 'gunicorn.*master' | head -1))"
              echo "Workers: $PID_COUNT processes"
              
              if [ $PID_COUNT -lt 2 ]; then
                echo "âš ï¸ WARNING: Expected at least 2 processes (master + workers)"
              fi
            else
              echo "âŒ Application is not running!"
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "Checking application health..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
                HEALTH_DATA=$(curl -s http://localhost:8000/health)
                echo "$HEALTH_DATA" | jq '.' || echo "$HEALTH_DATA"
                exit 0
              fi
              
              echo "Waiting for application to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
            
            echo "âŒ Application health check failed after $MAX_RETRIES attempts!"
            
            # ë¡œê·¸ ì¶œë ¥
            if [ -f "${{ env.APP_DIR }}/logs/service.log" ]; then
              echo "=== Last 100 lines of log ==="
              tail -100 ${{ env.APP_DIR }}/logs/service.log
            fi
            
            exit 1

      # ------------------------------------------------------
      # 7. ë°°í¬ ì •ë³´ ê¸°ë¡
      # ------------------------------------------------------
      - name: ğŸ“ Record deployment info
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            
            cat > deployment-info.json <<EOF
            {
              "environment": "development",
              "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "commit_sha": "${{ github.event.workflow_run.head_sha }}",
              "branch": "${{ github.event.workflow_run.head_branch }}",
              "deployer": "${{ github.event.workflow_run.head_commit.author.name }}",
              "workflow_run_id": "${{ github.run_id }}"
            }
            EOF
            
            echo "âœ… Deployment info recorded"
            cat deployment-info.json

      # ------------------------------------------------------
      # 8. Discord ì•Œë¦¼ - ì„±ê³µ
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… AI Service Dev ë°°í¬ ì„±ê³µ"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

      # ------------------------------------------------------
      # 9. Discord ì•Œë¦¼ - ì‹¤íŒ¨
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ AI Service Dev ë°°í¬ ì‹¤íŒ¨"
          embed-description: |
            **í™˜ê²½:** Development ğŸŸ¢
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

  # ============================================================
  # Production í™˜ê²½ ë°°í¬
  # ============================================================
  deploy-prod:
    name: Deploy to Production
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest
    environment:
      name: ai-production
    timeout-minutes: 20

    steps:
      # ------------------------------------------------------
      # 1. ë¹Œë“œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download build metadata
        uses: actions/download-artifact@v4
        with:
          name: ai-build-metadata-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: ğŸ“‹ Display and validate build metadata
        run: |
          if [ -f metadata.json ]; then
            echo "### ğŸ“Š Build Metadata" >> $GITHUB_STEP_SUMMARY
            cat metadata.json | jq '.' >> $GITHUB_STEP_SUMMARY
            
            # ì»¤ë²„ë¦¬ì§€ ê²€ì¦
            COVERAGE=$(cat metadata.json | jq -r '.coverage // "0"')
            echo "Test Coverage: ${COVERAGE}%"
            
            if [ "$COVERAGE" -lt 70 ]; then
              echo "::warning::Test coverage (${COVERAGE}%) is below 70%. Proceed with caution."
            fi
          else
            echo "âš ï¸ Build metadata not found"
          fi

      # ------------------------------------------------------
      # 2. ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      # ------------------------------------------------------
      - name: ğŸ“¥ Download application artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-app-main-${{ github.event.workflow_run.head_sha }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: ğŸ” Verify downloaded artifact
        run: |
          echo "### ğŸ“¦ Downloaded Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -lhR >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # í•„ìˆ˜ íŒŒì¼ í™•ì¸
          if [ ! -d "app" ]; then
            echo "::error::app directory not found!"
            exit 1
          fi
          
          if [ ! -f "requirements.txt" ]; then
            echo "::error::requirements.txt not found!"
            exit 1
          fi
          
          # SHA256 ì²´í¬ì„¬ ê³„ì‚°
          APP_SHA256=$(find app/ -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
          echo "Application SHA256: $APP_SHA256"
          
          echo "âœ… Artifact verification passed"

      # ------------------------------------------------------
      # 3. ë°°í¬ ì „ ì„œë²„ ìƒíƒœ í™•ì¸
      # ------------------------------------------------------
      - name: ğŸ” Check server status before deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Server Status Check ==="
            
            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
            echo "ğŸ“Š Disk Usage:"
            df -h ${{ env.APP_DIR }}
            DISK_USAGE=$(df ${{ env.APP_DIR }} | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$DISK_USAGE" -gt 85 ]; then
              echo "ERROR: Disk usage is critically high: ${DISK_USAGE}%"
              exit 1
            fi
            
            # ë©”ëª¨ë¦¬ í™•ì¸
            echo "ğŸ’¾ Memory Usage:"
            free -h
            
            # Qdrant ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking Qdrant..."
            if curl -sf http://localhost:6333/ > /dev/null; then
              echo "âœ… Qdrant is running"
            else
              echo "âŒ Qdrant is not accessible!"
              exit 1
            fi
            
            # Redis ìƒíƒœ í™•ì¸
            echo "ğŸ” Checking Redis..."
            if redis-cli -p 6380 ping > /dev/null 2>&1; then
              echo "âœ… Redis is running"
            else
              echo "âŒ Redis is not accessible!"
              exit 1
            fi
            
            # í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸
            echo "ğŸ”„ Current Application Status:"
            if pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              PID=$(pgrep -f "gunicorn.*master")
              echo "âœ… Application is running (PID: $PID)"
              
              # í—¬ìŠ¤ì²´í¬
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
              else
                echo "âš ï¸ Application is running but unhealthy"
              fi
            else
              echo "âš ï¸ Application is not running"
            fi
            
            # ë””ë ‰í† ë¦¬ ì¤€ë¹„
            mkdir -p ${{ env.APP_DIR }}
            mkdir -p ${{ env.BACKUP_DIR }}
            mkdir -p /tmp/ai-deploy
            
            echo "âœ… Production server check completed"

      # ------------------------------------------------------
      # 4. í˜„ì¬ ë²„ì „ ë°±ì—…
      # ------------------------------------------------------
      - name: ğŸ’¾ Backup current version
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ì—…
            if [ -d "app" ]; then
              tar -czf ${{ env.BACKUP_DIR }}/ai-app_prod_$TIMESTAMP.tar.gz app/ requirements.txt 2>/dev/null || true
              echo "âœ… Production backup created: ai-app_prod_$TIMESTAMP.tar.gz"
              
              # ë°±ì—… íŒŒì¼ ì •ë³´
              BACKUP_SIZE=$(stat -c%s ${{ env.BACKUP_DIR }}/ai-app_prod_$TIMESTAMP.tar.gz 2>/dev/null || echo "0")
              echo "Backup size: $BACKUP_SIZE bytes"
              
              # ë°°í¬ ì •ë³´ë„ ë°±ì—…
              if [ -f "deployment-info.json" ]; then
                cp deployment-info.json ${{ env.BACKUP_DIR }}/deployment-info_$TIMESTAMP.json
                echo "âœ… Deployment info backed up"
              fi
            else
              echo "âš ï¸ No existing app to backup (first deployment)"
            fi
            
            # ì˜¤ë˜ëœ ë°±ì—… ì‚­ì œ (ìµœê·¼ 10ê°œë§Œ ìœ ì§€)
            cd ${{ env.BACKUP_DIR }}
            ls -t ai-app_prod_*.tar.gz 2>/dev/null | tail -n +11 | xargs -r rm -v
            ls -t deployment-info_*.json 2>/dev/null | tail -n +11 | xargs -r rm -v
            
            echo "ğŸ“¦ Current backups:"
            ls -lh ai-app_prod_*.tar.gz 2>/dev/null || echo "No backups found"

      # ------------------------------------------------------
      # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
      # ------------------------------------------------------
      - name: ğŸ“¤ Transfer application to Production Server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          source: "app/,requirements.txt,build-artifacts/"
          target: "/tmp/ai-deploy"
          overwrite: true
          strip_components: 0

      # ------------------------------------------------------
      # 6. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # ------------------------------------------------------
      - name: ğŸš€ Run deployment script
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          command-timeout: 300s
          script: |
            cd ${{ env.APP_DIR }}
            
            # ìƒˆ ë²„ì „ ì¤€ë¹„
            echo "Preparing new version..."
            rm -rf /tmp/ai-deploy-staging
            mv /tmp/ai-deploy /tmp/ai-deploy-staging
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "${{ env.SCRIPTS_DIR }}/deploy-ai.sh" ]; then
              echo "Executing deploy-ai.sh..."
              chmod +x ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
              bash ${{ env.SCRIPTS_DIR }}/deploy-ai.sh
            else
              echo "ERROR: deploy-ai.sh not found!"
              exit 1
            fi

      # ------------------------------------------------------
      # 7. ë°°í¬ í›„ ê²€ì¦
      # ------------------------------------------------------
      - name: ğŸ¥ Post-deployment verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Post-Deployment Verification ==="
            
            # í”„ë¡œì„¸ìŠ¤ í™•ì¸
            if pgrep -f "gunicorn.*app.main:app" > /dev/null; then
              MASTER_PID=$(pgrep -f "gunicorn.*master" | head -1)
              WORKER_COUNT=$(pgrep -f "gunicorn.*worker" | wc -l)
              echo "âœ… Application is running (Master PID: $MASTER_PID)"
              echo "Workers: $WORKER_COUNT processes"
            else
              echo "âŒ Application is not running!"
              exit 1
            fi
            
            # í—¬ìŠ¤ì²´í¬ (ì—¬ëŸ¬ ë²ˆ ì‹œë„)
            echo "Checking application health..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Application is healthy"
                
                # ìƒì„¸ ì •ë³´ ì¶œë ¥
                echo "=== Health Details ==="
                curl -s http://localhost:8000/health | jq '.' || true
                
                exit 0
              fi
              
              echo "Waiting for application to be ready... ($((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done
            
            echo "âŒ Application health check failed after $MAX_RETRIES attempts!"
            
            # ë¡œê·¸ ì¶œë ¥
            if [ -f "${{ env.APP_DIR }}/logs/service.log" ]; then
              echo "=== Last 100 lines of log ==="
              tail -100 ${{ env.APP_DIR }}/logs/service.log
            fi
            
            exit 1

      # ------------------------------------------------------
      # 8. Smoke Test
      # ------------------------------------------------------
      - name: ğŸ§ª Run smoke tests
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=== Production Smoke Tests ==="
            
            FAILED=0
            
            # Test 1: Health
            echo "1. Testing health endpoint..."
            if curl -f -s http://localhost:8000/health > /dev/null; then
              echo "âœ… Health check passed"
            else
              echo "âŒ Health check failed"
              FAILED=$((FAILED + 1))
            fi
            
            # Test 2: Root endpoint
            echo "2. Testing root endpoint..."
            if curl -f -s http://localhost:8000/ > /dev/null; then
              echo "âœ… Root endpoint passed"
            else
              echo "âŒ Root endpoint failed"
              FAILED=$((FAILED + 1))
            fi
            
            # Test 3: Qdrant connectivity
            echo "3. Testing Qdrant connectivity..."
            QDRANT_STATUS=$(curl -s http://localhost:8000/health | jq -r '.services.qdrant // "UNKNOWN"')
            if [ "$QDRANT_STATUS" = "connected" ]; then
              echo "âœ… Qdrant connectivity passed"
            else
              echo "âš ï¸ Qdrant status: $QDRANT_STATUS"
            fi
            
            # Test 4: Redis connectivity
            echo "4. Testing Redis connectivity..."
            REDIS_STATUS=$(curl -s http://localhost:8000/health | jq -r '.services.redis // "UNKNOWN"')
            if [ "$REDIS_STATUS" = "connected" ]; then
              echo "âœ… Redis connectivity passed"
            else
              echo "âš ï¸ Redis status: $REDIS_STATUS"
            fi
            
            if [ $FAILED -gt 0 ]; then
              echo "âŒ $FAILED smoke test(s) failed"
              exit 1
            fi
            
            echo "âœ… All smoke tests passed"

      # ------------------------------------------------------
      # 9. ë°°í¬ ì •ë³´ ê¸°ë¡
      # ------------------------------------------------------
      - name: ğŸ“ Record deployment info
        if: success()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            APP_SHA256=$(find app/ -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)
            
            cat > deployment-info.json <<EOF
            {
              "environment": "production",
              "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "commit_sha": "${{ github.event.workflow_run.head_sha }}",
              "branch": "${{ github.event.workflow_run.head_branch }}",
              "deployer": "${{ github.event.workflow_run.head_commit.author.name }}",
              "workflow_run_id": "${{ github.run_id }}",
              "app_sha256": "$APP_SHA256"
            }
            EOF
            
            echo "âœ… Deployment info recorded"
            cat deployment-info.json

      # ------------------------------------------------------
      # 10. ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ (ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: âš ï¸ Rollback on failure
        if: failure() && steps.deploy.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.APP_DIR }}
            
            echo "=== Rolling back to previous version ==="
            
            if [ -f "${{ env.SCRIPTS_DIR }}/rollback-ai.sh" ]; then
              chmod +x ${{ env.SCRIPTS_DIR }}/rollback-ai.sh
              bash ${{ env.SCRIPTS_DIR }}/rollback-ai.sh
              
              # ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
              sleep 5
              if curl -f -s http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Rollback successful, application is healthy"
              else
                echo "âŒ Rollback completed but application is unhealthy!"
                echo "Manual intervention required!"
              fi
            else
              echo "âŒ rollback-ai.sh not found!"
              echo "Manual rollback required!"
            fi

      # ------------------------------------------------------
      # 11. Discord ì•Œë¦¼ - ì„±ê³µ
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… AI Service Production ë°°í¬ ì„±ê³µ"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            ğŸ‰ í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}

      # ------------------------------------------------------
      # 12. Discord ì•Œë¦¼ - ì‹¤íŒ¨
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure()
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CD Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ AI Service Production ë°°í¬ ì‹¤íŒ¨ (ë¡¤ë°± ì™„ë£Œ)"
          embed-description: |
            **í™˜ê²½:** Production ğŸ”´
            **ë¸Œëœì¹˜:** `${{ github.event.workflow_run.head_branch }}`
            **ì»¤ë°‹:** `${{ github.event.workflow_run.head_sha }}`
            **ë°°í¬ì:** ${{ github.event.workflow_run.head_commit.author.name }}
            
            âš ï¸ ë°°í¬ ì‹¤íŒ¨ë¡œ ìë™ ë¡¤ë°±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!
            
            [ğŸ“‹ CD ë¡œê·¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.workflow_run.updated_at }}