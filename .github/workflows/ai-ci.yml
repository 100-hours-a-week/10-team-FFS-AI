name: AI CI

# ============================================================
# íŠ¸ë¦¬ê±° ì„¤ì •: PRì´ ìƒì„±/ì—…ë°ì´íŠ¸ë  ë•Œ + ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìë™ ì‹¤í–‰
# ============================================================
on:
  # PR ì´ë²¤íŠ¸ (ì½”ë“œ ê²€ì¦ìš©)
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - dev
      - main
    # AI ê´€ë ¨ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
    paths:
      - 'app/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'requirements-dev.txt'
      - '.github/workflows/ai-ci.yml'

  # Push ì´ë²¤íŠ¸ (CD íŠ¸ë¦¬ê±°ìš©)
  push:
    branches:
      - dev
      - main
    paths:
      - 'app/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'requirements-dev.txt'
      - '.github/workflows/ai-ci.yml'

permissions:
  contents: read
  checks: write
  pull-requests: write

# ============================================================
# ë™ì‹œì„± ì œì–´: ê°™ì€ PR ë˜ëŠ” ë¸Œëœì¹˜ì—ì„œ ìƒˆ ì‹¤í–‰ ì‹œ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
# ============================================================
concurrency:
  group: ai-ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ============================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ============================================================
env:
  PYTHON_VERSION: '3.x'

# ============================================================
# CI ì‘ì—… ì •ì˜
# ============================================================
jobs:
  ai-ci:
    name: Lint, Test and Build
    runs-on: ubuntu-latest
    timeout-minutes: 20

    # ========================================================
    # í…ŒìŠ¤íŠ¸ìš© ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ
    # ========================================================
    services:
      redis:
        image: redis:7
        ports:
          - 6380:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=5

    # ========================================================
    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í…ŒìŠ¤íŠ¸ìš©)
    # ========================================================
    env:
      APP_ENV: ci
      DEBUG: False
      QDRANT_HOST: localhost
      QDRANT_PORT: 6333
      REDIS_HOST: localhost
      REDIS_PORT: 6380
      UPSTAGE_API_KEY: ${{ secrets.UPSTAGE_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    # ========================================================
    # CI ë‹¨ê³„ (Steps)
    # ========================================================
    steps:
      # ------------------------------------------------------
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ------------------------------------------------------
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------
      # 2. Python ì„¤ì • ë° ìºì‹±
      # ------------------------------------------------------
      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      # ------------------------------------------------------
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      # ------------------------------------------------------
      - name: ğŸ“¦ Install dependencies
        id: install
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          
          # ì„¤ì¹˜ëœ ì£¼ìš” íŒ¨í‚¤ì§€ ë²„ì „ ì¶œë ¥
          echo "### ğŸ“¦ Installed Packages" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pip list | grep -E "fastapi|uvicorn|gunicorn|qdrant|redis|boto3|httpx" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------
      # 4. ì •ì  ë¶„ì„ - Ruff Lint
      # ------------------------------------------------------
      - name: ğŸ” Run Ruff Lint
        id: ruff_lint
        run: |
          echo "Running Ruff lint..."
          ruff check app/ tests/ --output-format=github
        continue-on-error: true

      # ------------------------------------------------------
      # 5. ì½”ë“œ í¬ë§· ê²€ì‚¬ - Ruff Format
      # ------------------------------------------------------
      - name: ğŸ¨ Check code formatting
        id: ruff_format
        run: |
          echo "Checking code format..."
          ruff format --check app/ tests/
        continue-on-error: true

      # ------------------------------------------------------
      # 6. íƒ€ì… ì²´í¬ - MyPy (ì„ íƒì‚¬í•­)
      # ------------------------------------------------------
      - name: ğŸ“ Run type checking
        id: mypy
        run: |
          echo "Running MyPy type check..."
          mypy app/ --ignore-missing-imports || true
          echo "### ğŸ“ Type Check" >> $GITHUB_STEP_SUMMARY
          echo "MyPy íƒ€ì… ì²´í¬ ì™„ë£Œ (ê²½ê³ ë§Œ í‘œì‹œ)" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      # ------------------------------------------------------
      # 7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
      # ------------------------------------------------------
      - name: ğŸ§ª Run tests with coverage
        id: test
        run: |
          echo "Running tests with coverage..."
          pytest tests/ \
            -v \
            --tb=short \
            --maxfail=5 \
            --cov=app \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --junitxml=test-results.xml
        continue-on-error: false

      # ------------------------------------------------------
      # 8. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì¶”ì¶œ
      # ------------------------------------------------------
      - name: ğŸ“Š Extract test coverage
        id: coverage
        run: |
          # coverage.xmlì—ì„œ ì»¤ë²„ë¦¬ì§€ ì¶”ì¶œ
          if [ -f coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(int(float(root.attrib['line-rate']) * 100))")
          else
            COVERAGE="0"
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "### ğŸ“Š Test Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
          
          # ì»¤ë²„ë¦¬ì§€ê°€ ë„ˆë¬´ ë‚®ìœ¼ë©´ ê²½ê³ 
          if [ "$COVERAGE" -lt 70 ]; then
            echo "::warning::Test coverage is below 70% (${COVERAGE}%)"
          fi
        continue-on-error: true

      # ------------------------------------------------------
      # 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
      # ------------------------------------------------------
      - name: ğŸ“‹ Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: test-results.xml
          check_name: AI Test Results
          comment_mode: off

      # ------------------------------------------------------
      # 10. í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œ)
      # ------------------------------------------------------
      - name: ğŸ“¤ Upload test reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ai-test-reports-${{ github.event.pull_request.head.sha || github.sha }}
          path: |
            htmlcov/
            coverage.xml
            test-results.xml
          retention-days: 7

      # ------------------------------------------------------
      # 11. ì• í”Œë¦¬ì¼€ì´ì…˜ ì„í¬íŠ¸ í…ŒìŠ¤íŠ¸
      # ------------------------------------------------------
      - name: ğŸ” Test application import
        id: import_test
        run: |
          echo "Testing application import..."
          python -c "from app.main import app; print('âœ… Application import successful')"
        continue-on-error: false

      # ------------------------------------------------------
      # 12. Requirements íŒŒì¼ ìƒì„± (ë°°í¬ìš©)
      # ------------------------------------------------------
      - name: ğŸ“ Generate deployment requirements
        if: success()
        run: |
          echo "Generating deployment requirements..."
          mkdir -p build-artifacts
          
          # ë°°í¬ìš© requirements.txt ë³µì‚¬
          cp requirements.txt build-artifacts/
          
          # í™˜ê²½ ì •ë³´ ì €ì¥
          python --version > build-artifacts/python-version.txt
          pip list > build-artifacts/pip-list.txt

      # ------------------------------------------------------
      # 13. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (main)
      # ------------------------------------------------------
      - name: ğŸ“¦ Upload build artifacts (main)
        if: (github.base_ref == 'main' || github.ref_name == 'main') && success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-app-main-${{ github.event.pull_request.head.sha || github.sha }}
          path: |
            app/
            requirements.txt
            build-artifacts/
          retention-days: 90

      # ------------------------------------------------------
      # 14. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (dev)
      # ------------------------------------------------------
      - name: ğŸ“¦ Upload build artifacts (dev)
        if: (github.base_ref == 'dev' || github.ref_name == 'dev') && success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-app-dev-${{ github.event.pull_request.head.sha || github.sha }}
          path: |
            app/
            requirements.txt
            build-artifacts/
          retention-days: 7

      # ------------------------------------------------------
      # 15. ë¹Œë“œ ì •ë³´ ì €ì¥ (CDì—ì„œ ì‚¬ìš©)
      # ------------------------------------------------------
      - name: ğŸ’¾ Save build metadata
        if: success()
        run: |
          mkdir -p build-info
          cat > build-info/metadata.json <<EOF
          {
            "buildTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "commitSha": "${{ github.event.pull_request.head.sha || github.sha }}",
            "commitShort": "$(echo ${{ github.event.pull_request.head.sha || github.sha }} | cut -c1-7)",
            "branch": "${{ github.head_ref || github.ref_name }}",
            "baseBranch": "${{ github.base_ref || github.ref_name }}",
            "prNumber": "${{ github.event.pull_request.number || 'N/A' }}",
            "prTitle": "${{ github.event.pull_request.title || 'Direct Push' }}",
            "author": "${{ github.event.pull_request.user.login || github.actor }}",
            "coverage": "${{ steps.coverage.outputs.coverage }}",
            "pythonVersion": "$(python --version | cut -d' ' -f2)"
          }
          EOF
          cat build-info/metadata.json

      - name: ğŸ“¤ Upload build metadata
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ai-build-metadata-${{ github.event.pull_request.head.sha || github.sha }}
          path: build-info/metadata.json
          retention-days: 30

      # ------------------------------------------------------
      # 16. PRì— ê²°ê³¼ ì½”ë©˜íŠ¸ ì‘ì„±
      # ------------------------------------------------------
      - name: ğŸ’¬ Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}' || 'N/A';
            const ruffLint = '${{ steps.ruff_lint.outcome }}';
            const ruffFormat = '${{ steps.ruff_format.outcome }}';
            const test = '${{ steps.test.outcome }}';
            const importTest = '${{ steps.import_test.outcome }}';
            
            const getIcon = (status) => status === 'success' ? 'âœ…' : status === 'failure' ? 'âŒ' : 'âš ï¸';
            
            const getCoverageColor = (cov) => {
              const num = parseInt(cov);
              if (num >= 80) return 'ğŸŸ¢';
              if (num >= 70) return 'ğŸŸ¡';
              return 'ğŸ”´';
            };
            
            const body = `## ğŸ¤– AI Service CI Results
            
            | Check | Status | Details |
            |-------|--------|---------|
            | ğŸ” Code Lint | ${getIcon(ruffLint)} ${ruffLint} | Ruff ë¦°íŠ¸ ê²€ì‚¬ |
            | ğŸ¨ Code Format | ${getIcon(ruffFormat)} ${ruffFormat} | Ruff í¬ë§· ê²€ì‚¬ |
            | ğŸ§ª Tests | ${getIcon(test)} ${test} | ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ |
            | ğŸ“¦ Import Test | ${getIcon(importTest)} ${importTest} | ì•± ì„í¬íŠ¸ ê²€ì¦ |
            | ğŸ“Š Coverage | ${getCoverageColor(coverage)} ${coverage}% | í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ |
            
            <details>
            <summary>ğŸ“‹ ìƒì„¸ ì •ë³´</summary>
            
            - **ë¸Œëœì¹˜:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`
            - **ì»¤ë°‹:** \`${context.payload.pull_request.head.sha.substring(0, 7)}\`
            - **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            
            ### ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€
            - ğŸŸ¢ 80% ì´ìƒ: ìš°ìˆ˜
            - ğŸŸ¡ 70-79%: ì–‘í˜¸
            - ğŸ”´ 70% ë¯¸ë§Œ: ê°œì„  í•„ìš”
            
            [ğŸ“Š ì „ì²´ ë¦¬í¬íŠ¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            </details>
            
            ${coverage < 70 ? '\nâš ï¸ **ì£¼ì˜:** í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ê¸°ì¤€(70%)ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤.' : ''}
            ${test === 'failure' ? '\nâŒ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:** ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' : ''}
            `;
            
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('AI Service CI Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      # ------------------------------------------------------
      # 17. Discord ì•Œë¦¼ - ì„±ê³µ (PR only)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on success
        if: success() && github.event_name == 'pull_request'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CI Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âœ… AI Service CI ì„±ê³µ"
          embed-description: |
            **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜:** `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
            **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            **ì»¤ë²„ë¦¬ì§€:** ${{ steps.coverage.outputs.coverage }}%
            
            ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰
            
            [ğŸ”— PR ë³´ê¸°](${{ github.event.pull_request.html_url }})
          embed-color: 3066993
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.pull_request.updated_at }}

      # ------------------------------------------------------
      # 18. Discord ì•Œë¦¼ - ì‹¤íŒ¨ (PR only)
      # ------------------------------------------------------
      - name: ğŸ“¢ Send Discord notification on failure
        if: failure() && github.event_name == 'pull_request'
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          username: "AI CI Bot"
          avatar-url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
          embed-title: "âŒ AI Service CI ì‹¤íŒ¨"
          embed-description: |
            **PR:** #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}
            **ë¸Œëœì¹˜:** `${{ github.head_ref }}` â†’ `${{ github.base_ref }}`
            **ì‘ì„±ì:** @${{ github.event.pull_request.user.login }}
            
            **ì‹¤íŒ¨ ë‹¨ê³„:**
            â€¢ Lint: ${{ steps.ruff_lint.outcome }}
            â€¢ Format: ${{ steps.ruff_format.outcome }}
            â€¢ Tests: ${{ steps.test.outcome }}
            â€¢ Import: ${{ steps.import_test.outcome }}
            
            [ğŸ”— PR ë³´ê¸°](${{ github.event.pull_request.html_url }})
            [ğŸ“‹ CI ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          embed-color: 15158332
          embed-footer-text: ${{ github.repository }}
          embed-timestamp: ${{ github.event.pull_request.updated_at }}